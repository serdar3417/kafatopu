<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kafa Topu Arena Pro</title>
    <style>
        * { 
            box-sizing: border-box; 
            margin: 0;
            padding: 0;
        }
        
        body {
            background: linear-gradient(135deg, #0c4a6e, #1e40af, #7c3aed);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            padding: 10px;
        }

        #game-container {
            position: relative;
            border: 5px solid #fff;
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.8);
            border-radius: 15px;
            overflow: hidden;
            max-width: 100vw;
            max-height: 100vh;
        }

        canvas {
            display: block;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8E8 100%);
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10;
        }

        .overlay h1 {
            font-size: clamp(24px, 6vw, 50px);
            color: #FFD700;
            text-shadow: 3px 3px 0px #ff0000, 6px 6px 10px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .overlay p {
            font-size: clamp(10px, 2.5vw, 16px);
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .overlay button {
            font-size: clamp(12px, 3vw, 18px);
            padding: 15px 25px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: 3px solid white;
            border-radius: 10px;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.3s;
            min-width: 200px;
        }

        .overlay button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.6);
        }

        .mode-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }

        .mode-btn:hover {
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.6);
        }

        .settings-btn {
            background: linear-gradient(45deg, #FF9800, #F57C00) !important;
        }

        .settings-btn:hover {
            box-shadow: 0 0 20px rgba(255, 152, 0, 0.6) !important;
        }

        #end-screen, #settings-screen {
            display: none;
        }

        .game-controls {
            position: absolute;
            top: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .control-btn {
            position: absolute;
            width: 80px;
            height: 80px;
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
            pointer-events: all;
            touch-action: none;
            user-select: none;
            backdrop-filter: blur(10px);
            transition: all 0.2s;
        }

        .control-btn:active {
            transform: scale(0.9);
            opacity: 0.8;
        }

        .p1-left {
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 65, 54, 0.3);
            border-color: #ff4136;
            color: #ff4136;
        }

        .p1-right {
            left: 120px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 65, 54, 0.3);
            border-color: #ff4136;
            color: #ff4136;
        }

        .p1-jump {
            left: 20px;
            top: 30%;
            transform: translateY(-50%);
            background: rgba(255, 65, 54, 0.3);
            border-color: #ff4136;
            color: #ff4136;
        }

        .p1-kick {
            left: 120px;
            top: 30%;
            transform: translateY(-50%);
            background: rgba(255, 65, 54, 0.3);
            border-color: #ff4136;
            color: #ff4136;
        }

        .p2-left {
            right: 120px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 116, 217, 0.3);
            border-color: #0074d9;
            color: #0074d9;
        }

        .p2-right {
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 116, 217, 0.3);
            border-color: #0074d9;
            color: #0074d9;
        }

        .p2-jump {
            right: 120px;
            top: 30%;
            transform: translateY(-50%);
            background: rgba(0, 116, 217, 0.3);
            border-color: #0074d9;
            color: #0074d9;
        }

        .p2-kick {
            right: 20px;
            top: 30%;
            transform: translateY(-50%);
            background: rgba(0, 116, 217, 0.3);
            border-color: #0074d9;
            color: #0074d9;
        }

        @media (max-width: 768px) {
            body { padding: 5px; }
            
            #game-container {
                border-width: 3px;
                border-radius: 10px;
            }
            
            .control-btn {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }

            .p1-left { left: 10px; }
            .p1-right { left: 80px; }
            .p1-jump { left: 10px; }
            .p1-kick { left: 80px; }
            .p2-left { right: 80px; }
            .p2-right { right: 10px; }
            .p2-jump { right: 80px; }
            .p2-kick { right: 10px; }
        }

        .settings-container {
            max-width: 500px;
            padding: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .setting-item {
            margin-bottom: 20px;
            text-align: left;
        }

        .setting-item label {
            display: block;
            font-size: 12px;
            margin-bottom: 10px;
            color: #FFD700;
        }

        .setting-item input, .setting-item select {
            width: 100%;
            padding: 8px;
            font-size: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid white;
            border-radius: 5px;
            color: white;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 10px 15px;
            background: linear-gradient(45deg, #9C27B0, #7B1FA2);
            color: white;
            border: 2px solid white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.3s;
            width: 100%;
            text-align: center;
            margin-bottom: 10px;
        }

        .file-label:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(156, 39, 176, 0.6);
        }

        .preview {
            width: 100px;
            height: 100px;
            border: 2px solid white;
            border-radius: 10px;
            margin: 10px auto;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 8px;
            text-align: center;
            overflow: hidden;
        }

        .preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .background-preview {
            width: 200px;
            height: 100px;
        }

        .clear-btn {
            background: linear-gradient(45deg, #FF5722, #D84315) !important;
            padding: 5px 10px !important;
            font-size: 8px !important;
            margin-top: 5px;
            min-width: auto !important;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas" width="800" height="450"></canvas>
        
        <div class="game-controls" id="game-controls" style="display: none;">
            <div class="control-btn p1-left" id="p1-left">‹</div>
            <div class="control-btn p1-right" id="p1-right">›</div>
            <div class="control-btn p1-jump" id="p1-jump">↑</div>
            <div class="control-btn p1-kick" id="p1-kick">⚽</div>
            
            <div class="control-btn p2-left" id="p2-left">‹</div>
            <div class="control-btn p2-right" id="p2-right">›</div>
            <div class="control-btn p2-jump" id="p2-jump">↑</div>
            <div class="control-btn p2-kick" id="p2-kick">⚽</div>
        </div>
        
        <div id="start-screen" class="overlay">
            <h1>KAFA TOPU PRO</h1>
            <p>Yeni nesil kafa topu deneyimi!</p>
            <div class="button-container">
                <button id="single-mode-btn" class="mode-btn">TEK OYUNCU</button>
                <button id="two-player-mode-btn" class="mode-btn">İKİ OYUNCU</button>
                <button id="settings-btn" class="settings-btn">AYARLAR</button>
            </div>
        </div>

        <div id="end-screen" class="overlay">
            <h1 id="result-text">MAÇ BİTTİ</h1>
            <p id="final-score-text">Skor: 0 - 0</p>
            <div class="button-container">
                <button id="restart-btn">YENİDEN OYNA</button>
                <button id="main-menu-btn">ANA MENÜ</button>
            </div>
        </div>

        <div id="settings-screen" class="overlay">
            <div class="settings-container">
                <h1>AYARLAR</h1>
                
                <div class="setting-item">
                    <label>Oyun Arkaplanı:</label>
                    <input type="file" id="bg-input" class="file-input" accept="image/*">
                    <label for="bg-input" class="file-label">Özel Arkaplan Seç</label>
                    <button class="clear-btn" id="clear-bg">Varsayılan</button>
                    <div class="preview background-preview" id="bg-preview">Yükleniyor...</div>
                </div>

                <div class="setting-item">
                    <label>Top Görseli:</label>
                    <input type="file" id="ball-input" class="file-input" accept="image/*">
                    <label for="ball-input" class="file-label">Özel Top Seç</label>
                    <button class="clear-btn" id="clear-ball">Varsayılan</button>
                    <div class="preview" id="ball-preview">Yükleniyor...</div>
                </div>

                <div class="setting-item">
                    <label>Sol Kale Görseli:</label>
                    <input type="file" id="goal1-input" class="file-input" accept="image/*">
                    <label for="goal1-input" class="file-label">Özel Sol Kale Seç</label>
                    <button class="clear-btn" id="clear-goal1">Varsayılan</button>
                    <div class="preview" id="goal1-preview">Yükleniyor...</div>
                </div>

                <div class="setting-item">
                    <label>Sağ Kale Görseli:</label>
                    <input type="file" id="goal2-input" class="file-input" accept="image/*">
                    <label for="goal2-input" class="file-label">Özel Sağ Kale Seç</label>
                    <button class="clear-btn" id="clear-goal2">Varsayılan</button>
                    <div class="preview" id="goal2-preview">Yükleniyor...</div>
                </div>
                
                <div class="setting-item">
                    <label>Oyuncu 1 Karakteri:</label>
                    <input type="file" id="p1-char-input" class="file-input" accept="image/*">
                    <label for="p1-char-input" class="file-label">Özel Karakter Seç</label>
                    <button class="clear-btn" id="clear-p1">Varsayılan</button>
                    <div class="preview" id="p1-preview">Yükleniyor...</div>
                </div>

                <div class="setting-item">
                    <label>Oyuncu 2 Karakteri:</label>
                    <input type="file" id="p2-char-input" class="file-input" accept="image/*">
                    <label for="p2-char-input" class="file-label">Özel Karakter Seç</label>
                    <button class="clear-btn" id="clear-p2">Varsayılan</button>
                    <div class="preview" id="p2-preview">Yükleniyor...</div>
                </div>

                <div class="setting-item">
                    <label>Maç Süresi:</label>
                    <select id="match-duration">
                        <option value="60">1 Dakika</option>
                        <option value="90" selected>1.5 Dakika</option>
                        <option value="120">2 Dakika</option>
                        <option value="180">3 Dakika</option>
                    </select>
                </div>

                <div class="setting-item">
                    <label>Zorluk Seviyesi:</label>
                    <select id="difficulty">
                        <option value="easy">Kolay</option>
                        <option value="normal" selected>Normal</option>
                        <option value="hard">Zor</option>
                    </select>
                </div>

                <div class="button-container">
                    <button id="save-settings-btn">KAYDET</button>
                    <button id="back-to-menu-btn">GERİ DÖN</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Canvas ve context
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Canvas boyutlandırma
        function resizeCanvas() {
            const maxWidth = window.innerWidth - 20;
            const maxHeight = window.innerHeight - 20;
            const aspectRatio = 800 / 450;
            
            let newWidth = Math.min(800, maxWidth);
            let newHeight = newWidth / aspectRatio;
            
            if (newHeight > maxHeight) {
                newHeight = maxHeight;
                newWidth = newHeight * aspectRatio;
            }
            
            canvas.style.width = newWidth + 'px';
            canvas.style.height = newHeight + 'px';
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // DOM elementleri
        const startScreen = document.getElementById('start-screen');
        const endScreen = document.getElementById('end-screen');
        const settingsScreen = document.getElementById('settings-screen');
        const gameControls = document.getElementById('game-controls');
        const resultText = document.getElementById('result-text');
        const finalScoreText = document.getElementById('final-score-text');

        // Oyun ayarları
        const settings = {
            GRAVITY: 0.6,
            PLAYER_SPEED: 4,
            JUMP_FORCE: -13,
            KICK_FORCE: 15,
            BALL_FRICTION: 0.98,
            PLAYER_FRICTION: 0.9,
            MATCH_DURATION: 90,
            DIFFICULTY: 'normal',
            AI_SPEED_MULTIPLIER: 0.8,
            AI_REACTION_TIME: 10
        };

        // Oyun değişkenleri
        let gameState = 'MENU';
        let gameMode = 'single';
        let timer = settings.MATCH_DURATION;
        let timerInterval = null;
        let goalMessageTimeout = null;
        let goalScored = false; // Gol kontrolü için

        // Görsel öğeleri
        let player1Image = null;
        let player2Image = null;
        let backgroundImage = null;
        let ballImage = null;
        let goal1Image = null;
        let goal2Image = null;

        // Varsayılan görseller
        const defaultImages = {
            player1: 'images/soloyuncu.png',
            player2: 'images/sagoyuncu.png',
            background: 'images/arkaplan.png',
            ball: 'images/top.png',
            goal1: 'images/solkale.png',
            goal2: 'images/sagkale.png'
        };

        // Saklanan ayarlar
        let savedSettings = {
            matchDuration: 90,
            difficulty: 'normal',
            player1ImageData: null,
            player2ImageData: null,
            backgroundImageData: null,
            ballImageData: null,
            goal1ImageData: null,
            goal2ImageData: null
        };

        // Oyun nesneleri
        const groundY = canvas.height - 40;

        const player1 = {
            x: canvas.width * 0.25,
            y: groundY,
            w: 80, h: 60, headRadius: 35,
            dx: 0, dy: 0,
            onGround: true,
            score: 0,
            color: '#ff4136',
            keys: {
                left: 'ArrowLeft',
                right: 'ArrowRight',
                up: 'ArrowUp',
                kick: 'Space'
            }
        };

        const player2 = {
            x: canvas.width * 0.75,
            y: groundY,
            w: 80, h: 60, headRadius: 35,
            dx: 0, dy: 0,
            onGround: true,
            score: 0,
            color: '#0074d9',
            keys: {
                left: 'KeyA',
                right: 'KeyD',
                up: 'KeyW',
                kick: 'KeyS'
            },
            isAI: true
        };

        const ball = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            r: 25,
            dx: 0, dy: 0
        };

        const goal1 = { x: 0, y: groundY - 100, w: 100, h: 100 };
        const goal2 = { x: canvas.width - 100, y: groundY - 100, w: 100, h: 100 };

        // Kontrol sistemi
        const keys = {};

        window.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            e.preventDefault();
        });

        window.addEventListener('keyup', (e) => {
            keys[e.code] = false;
            e.preventDefault();
        });

        // Varsayılan görselleri yükleme
        function loadDefaultImages() {
            if (defaultImages.player1) {
                const img = new Image();
                img.onload = () => {
                    if (!savedSettings.player1ImageData) {
                        player1Image = img;
                        document.getElementById('p1-preview').innerHTML = '<img src="' + defaultImages.player1 + '" alt="Sol Oyuncu">';
                    }
                };
                img.onerror = () => {
                    document.getElementById('p1-preview').innerHTML = 'Varsayılan';
                };
                img.src = defaultImages.player1;
            }

            if (defaultImages.player2) {
                const img = new Image();
                img.onload = () => {
                    if (!savedSettings.player2ImageData) {
                        player2Image = img;
                        document.getElementById('p2-preview').innerHTML = '<img src="' + defaultImages.player2 + '" alt="Sağ Oyuncu">';
                    }
                };
                img.onerror = () => {
                    document.getElementById('p2-preview').innerHTML = 'Varsayılan';
                };
                img.src = defaultImages.player2;
            }

            if (defaultImages.background) {
                const img = new Image();
                img.onload = () => {
                    if (!savedSettings.backgroundImageData) {
                        backgroundImage = img;
                        document.getElementById('bg-preview').innerHTML = '<img src="' + defaultImages.background + '" alt="Arkaplan">';
                    }
                };
                img.onerror = () => {
                    document.getElementById('bg-preview').innerHTML = 'Varsayılan';
                };
                img.src = defaultImages.background;
            }

            if (defaultImages.ball) {
                const img = new Image();
                img.onload = () => {
                    if (!savedSettings.ballImageData) {
                        ballImage = img;
                        document.getElementById('ball-preview').innerHTML = '<img src="' + defaultImages.ball + '" alt="Top">';
                    }
                };
                img.onerror = () => {
                    document.getElementById('ball-preview').innerHTML = 'Varsayılan';
                };
                img.src = defaultImages.ball;
            }

            if (defaultImages.goal1) {
                const img = new Image();
                img.onload = () => {
                    if (!savedSettings.goal1ImageData) {
                        goal1Image = img;
                        document.getElementById('goal1-preview').innerHTML = '<img src="' + defaultImages.goal1 + '" alt="Sol Kale">';
                    }
                };
                img.onerror = () => {
                    document.getElementById('goal1-preview').innerHTML = 'Varsayılan';
                };
                img.src = defaultImages.goal1;
            }

            if (defaultImages.goal2) {
                const img = new Image();
                img.onload = () => {
                    if (!savedSettings.goal2ImageData) {
                        goal2Image = img;
                        document.getElementById('goal2-preview').innerHTML = '<img src="' + defaultImages.goal2 + '" alt="Sağ Kale">';
                    }
                };
                img.onerror = () => {
                    document.getElementById('goal2-preview').innerHTML = 'Varsayılan';
                };
                img.src = defaultImages.goal2;
            }
        }

        // Oyun kontrolleri kurulumu
        function setupGameControls() {
            const touchEvents = ['touchstart', 'touchend'];
            const mouseEvents = ['mousedown', 'mouseup'];
            
            function addControlEvents(elementId, key) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                touchEvents.forEach(event => {
                    element.addEventListener(event, (e) => {
                        e.preventDefault();
                        keys[key] = event === 'touchstart';
                    });
                });
                
                mouseEvents.forEach(event => {
                    element.addEventListener(event, (e) => {
                        e.preventDefault();
                        keys[key] = event === 'mousedown';
                    });
                });
                
                element.addEventListener('mouseleave', (e) => {
                    e.preventDefault();
                    keys[key] = false;
                });
            }

            addControlEvents('p1-left', player1.keys.left);
            addControlEvents('p1-right', player1.keys.right);
            addControlEvents('p1-jump', player1.keys.up);
            addControlEvents('p1-kick', player1.keys.kick);
            addControlEvents('p2-left', player2.keys.left);
            addControlEvents('p2-right', player2.keys.right);
            addControlEvents('p2-jump', player2.keys.up);
            addControlEvents('p2-kick', player2.keys.kick);
        }

        // Çizim fonksiyonları
        function drawField() {
            if (backgroundImage) {
                ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else {
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(0.6, '#98D8E8');
                gradient.addColorStop(1, '#2ECC40');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            const groundGradient = ctx.createLinearGradient(0, groundY, 0, canvas.height);
            groundGradient.addColorStop(0, '#2ECC40');
            groundGradient.addColorStop(1, '#27AE60');
            ctx.fillStyle = groundGradient;
            ctx.fillRect(0, groundY, canvas.width, canvas.height - groundY);
            
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, groundY);
            ctx.lineTo(canvas.width, groundY);
            ctx.stroke();

            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, groundY);
            ctx.lineTo(canvas.width / 2, groundY - 120);
            ctx.stroke();

            if (goal1Image) {
                ctx.drawImage(goal1Image, goal1.x, goal1.y, goal1.w, goal1.h);
            } else {
                ctx.strokeStyle = '#DDDDDD';
                ctx.lineWidth = 5;
                ctx.strokeRect(goal1.x, goal1.y, goal1.w, goal1.h);
            }

            if (goal2Image) {
                ctx.drawImage(goal2Image, goal2.x, goal2.y, goal2.w, goal2.h);
            } else {
                ctx.strokeStyle = '#DDDDDD';
                ctx.lineWidth = 5;
                ctx.strokeRect(goal2.x, goal2.y, goal2.w, goal2.h);
            }
        }

        function drawPlayer(p, playerImage) {
            ctx.save();
            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
            ctx.shadowBlur = 5;
            ctx.shadowOffsetY = 3;

            if (playerImage) {
                ctx.drawImage(playerImage, 
                    p.x - p.headRadius, p.y - p.h - p.headRadius, 
                    p.headRadius * 2, p.headRadius * 2);
            } else {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x - p.w / 2, p.y - p.h, p.w, p.h);

                ctx.beginPath();
                ctx.arc(p.x, p.y - p.h, p.headRadius, 0, Math.PI * 2);
                ctx.fillStyle = '#F3D1B9';
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.stroke();

                const eyeDirection = ball.x > p.x ? 1 : -1;
                ctx.shadowBlur = 0;
                
                ctx.beginPath();
                ctx.arc(p.x - 12, p.y - p.h - 7, 6, 0, Math.PI * 2);
                ctx.fillStyle = 'white';
                ctx.fill();
                ctx.beginPath();
                ctx.arc(p.x - 12 + eyeDirection * 3, p.y - p.h - 7, 3, 0, Math.PI * 2);
                ctx.fillStyle = 'black';
                ctx.fill();

                ctx.beginPath();
                ctx.arc(p.x + 12, p.y - p.h - 7, 6, 0, Math.PI * 2);
                ctx.fillStyle = 'white';
                ctx.fill();
                ctx.beginPath();
                ctx.arc(p.x + 12 + eyeDirection * 3, p.y - p.h - 7, 3, 0, Math.PI * 2);
                ctx.fillStyle = 'black';
                ctx.fill();

                ctx.beginPath();
                ctx.arc(p.x, p.y - p.h + 14, 7, 0, Math.PI);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            
            ctx.restore();
        }

        function drawBall() {
            ctx.save();
            
            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
            ctx.shadowBlur = 8;
            ctx.shadowOffsetY = 5;

            if (ballImage) {
                ctx.drawImage(ballImage, 
                    ball.x - ball.r, ball.y - ball.r, 
                    ball.r * 2, ball.r * 2);
            } else {
                const gradient = ctx.createRadialGradient(
                    ball.x - 5, ball.y - 5, 0,
                    ball.x, ball.y, ball.r
                );
                gradient.addColorStop(0, '#FFFFFF');
                gradient.addColorStop(1, '#E0E0E0');
                
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();
                
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.shadowBlur = 0;
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.r * 0.3, 0, Math.PI * 2);
                ctx.stroke();
                
                for(let i = 0; i < 6; i++) {
                    const angle = (i * Math.PI * 2) / 6;
                    ctx.beginPath();
                    ctx.moveTo(ball.x, ball.y);
                    ctx.lineTo(
                        ball.x + Math.cos(angle) * ball.r * 0.8,
                        ball.y + Math.sin(angle) * ball.r * 0.8
                    );
                    ctx.stroke();
                }
            }

            ctx.restore();
        }

        function drawUI() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(canvas.width / 2 - 120, 10, 240, 80);
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 2;
            ctx.strokeRect(canvas.width / 2 - 120, 10, 240, 80);

            ctx.fillStyle = 'white';
            ctx.font = "24px Arial";
            ctx.textAlign = 'center';
            
            ctx.fillStyle = '#FFD700';
            ctx.fillText(`${player1.score} - ${player2.score}`, canvas.width / 2, 40);

            const minutes = Math.floor(timer / 60);
            const seconds = timer % 60;
            ctx.fillStyle = timer <= 10 ? '#FF4136' : 'white';
            ctx.font = "16px Arial";
            ctx.fillText(`${minutes}:${seconds < 10 ? '0' : ''}${seconds}`, canvas.width / 2, 70);

            if (gameMode === 'two-player') {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(10, 10, 150, 30);
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 2;
                ctx.strokeRect(10, 10, 150, 30);
                ctx.fillStyle = '#FFD700';
                ctx.font = "12px Arial";
                ctx.textAlign = 'left';
                ctx.fillText('İKİ OYUNCU', 15, 30);
            }
        }

        // Fizik fonksiyonları
        function updatePhysics(p) {
            if (!p.onGround) {
                p.dy += settings.GRAVITY;
            }
            p.y += p.dy;
            p.x += p.dx;

            p.dx *= settings.PLAYER_FRICTION;

            if (p.y >= groundY) {
                p.y = groundY;
                p.dy = 0;
                p.onGround = true;
            }

            if (p.x - p.headRadius < 0) p.x = p.headRadius;
            if (p.x + p.headRadius > canvas.width) p.x = canvas.width - p.headRadius;
        }

        function handlePlayerInput(p) {
            if (keys[p.keys.left]) p.dx = -settings.PLAYER_SPEED;
            if (keys[p.keys.right]) p.dx = settings.PLAYER_SPEED;
            if (keys[p.keys.up] && p.onGround) {
                p.dy = settings.JUMP_FORCE;
                p.onGround = false;
            }
        }

        function updateAI(ai) {
            if (!ai.isAI) return;

            const distToBallX = ball.x - ai.x;
            const distToBallY = ball.y - ai.y;
            const speedMultiplier = settings.AI_SPEED_MULTIPLIER || 0.8;
            const reactionTime = settings.AI_REACTION_TIME || 10;

            if (Math.random() * 60 < reactionTime) {
                return;
            }

            if (ball.x > canvas.width / 2) {
                if (distToBallX > 10) {
                    ai.dx = settings.PLAYER_SPEED * speedMultiplier;
                } else if (distToBallX < -10) {
                    ai.dx = -settings.PLAYER_SPEED * speedMultiplier;
                }

                if (ai.onGround && distToBallY < -30 && Math.abs(distToBallX) < 80) {
                    ai.dy = settings.JUMP_FORCE;
                    ai.onGround = false;
                }
            } else {
                const defensivePos = canvas.width * 0.75;
                if (ai.x < defensivePos - 20) {
                    ai.dx = settings.PLAYER_SPEED * speedMultiplier * 0.7;
                } else if (ai.x > defensivePos + 20) {
                    ai.dx = -settings.PLAYER_SPEED * speedMultiplier * 0.7;
                }
            }
        }

        function updateBall() {
            ball.dy += settings.GRAVITY * 0.7;
            ball.x += ball.dx;
            ball.y += ball.dy;

            ball.dx *= settings.BALL_FRICTION;
            ball.dy *= settings.BALL_FRICTION;

            if (ball.x + ball.r > canvas.width || ball.x - ball.r < 0) {
                ball.dx *= -0.8;
                if (ball.x + ball.r > canvas.width) ball.x = canvas.width - ball.r;
                if (ball.x - ball.r < 0) ball.x = ball.r;
            }
            
            if (ball.y - ball.r < 0) {
                ball.dy *= -0.8;
                ball.y = ball.r;
            }

            if (ball.y + ball.r > groundY) {
                ball.y = groundY - ball.r;
                ball.dy *= -0.7;
            }
        }

        function checkCollision(p, b) {
            let distHead = Math.sqrt((p.x - b.x)**2 + ((p.y - p.h) - b.y)**2);
            if (distHead < p.headRadius + b.r) {
                handleCollision(p, b, true);
            }

            let closestX = Math.max(p.x - p.w/2, Math.min(b.x, p.x + p.w/2));
            let closestY = Math.max(p.y - p.h, Math.min(b.y, p.y));
            let distBody = Math.sqrt((closestX - b.x)**2 + (closestY - b.y)**2);
            if(distBody < b.r){
                handleCollision(p, b, false);
            }
        }

        function handleCollision(p, b, isHead) {
            const angle = Math.atan2(b.y - (p.y - p.h), b.x - p.x);
            let force = isHead ? settings.KICK_FORCE * 1.2 : settings.KICK_FORCE * 0.8;
            
            const isKicking = keys[p.keys.kick] || (p.isAI && Math.abs(b.x - p.x) < 80);
            if (isKicking) {
                force *= 1.5;
            }

            b.dx = Math.cos(angle) * force + p.dx * 0.5;
            b.dy = Math.sin(angle) * force + p.dy * 0.5;
        }

        function checkGoal() {
            if (goalScored) return; // Eğer gol olmuşsa tekrar kontrol etme
            
            if (ball.y > goal1.y && ball.y < goal1.y + goal1.h) {
                if (ball.x - ball.r < goal1.x + goal1.w) {
                    handleGoalScored(player2);
                } else if (ball.x + ball.r > goal2.x) {
                    handleGoalScored(player1);
                }
            }
        }

        function handleGoalScored(scorer) {
            if (goalScored) return; // Çift gol önleme
            
            goalScored = true; // Gol bayrağını set et
            scorer.score++;
            
            // Alkış sesi çal
            const applauseSound = new Audio('sounds/alkis.mp3');
            applauseSound.play().catch(() => {
                console.log('Alkış sesi çalınamadı');
            });
            
            // Gol mesajı göster
            showGoalMessage();
            
            setTimeout(() => {
                resetPositions();
                goalScored = false; // Reset gol bayrağı
            }, 2000); // 2 saniye bekle
        }

        function showGoalMessage() {
            if (!goalMessageTimeout) {
                goalMessageTimeout = setTimeout(() => {
                    goalMessageTimeout = null;
                }, 1000);
            }
        }

        function drawGoalMessage() {
            if (goalMessageTimeout) {
                ctx.save();
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#FFD700';
                ctx.font = 'bold 72px Arial';
                ctx.textAlign = 'center';
                ctx.strokeStyle = '#FF0000';
                ctx.lineWidth = 4;
                
                const goalText = 'Goooolll!!!!';
                ctx.strokeText(goalText, canvas.width / 2, canvas.height / 2);
                ctx.fillText(goalText, canvas.width / 2, canvas.height / 2);
                ctx.restore();
            }
        }

        function resetPositions() {
            player1.x = canvas.width * 0.25;
            player1.y = groundY;
            player1.dx = player1.dy = 0;
            player1.onGround = true;

            player2.x = canvas.width * 0.75;
            player2.y = groundY;
            player2.dx = player2.dy = 0;
            player2.onGround = true;

            ball.x = canvas.width / 2;
            ball.y = canvas.height / 2;
            ball.dx = (Math.random() - 0.5) * 5;
            ball.dy = 0;
            
            goalScored = false; // Reset gol bayrağı
        }

        function updateControlVisibility() {
            const p2Controls = document.querySelectorAll('.p2-left, .p2-right, .p2-jump, .p2-kick');
            if (gameMode === 'single') {
                p2Controls.forEach(ctrl => ctrl.style.display = 'none');
            } else {
                p2Controls.forEach(ctrl => ctrl.style.display = 'flex');
            }
        }

        // Menü fonksiyonları
        function showMainMenu() {
            gameState = 'MENU';
            startScreen.style.display = 'flex';
            endScreen.style.display = 'none';
            settingsScreen.style.display = 'none';
            gameControls.style.display = 'none';
            if (timerInterval) clearInterval(timerInterval);
        }

        function showSettings() {
            startScreen.style.display = 'none';
            settingsScreen.style.display = 'flex';
            loadSavedSettings();
        }

        function saveSettings() {
            const matchDuration = document.getElementById('match-duration').value;
            const difficulty = document.getElementById('difficulty').value;
            
            savedSettings.matchDuration = parseInt(matchDuration);
            savedSettings.difficulty = difficulty;
            
            settings.MATCH_DURATION = parseInt(matchDuration);
            settings.DIFFICULTY = difficulty;
            
            switch(difficulty) {
                case 'easy':
                    settings.AI_SPEED_MULTIPLIER = 0.6;
                    settings.AI_REACTION_TIME = 20;
                    break;
                case 'normal':
                    settings.AI_SPEED_MULTIPLIER = 0.8;
                    settings.AI_REACTION_TIME = 10;
                    break;
                case 'hard':
                    settings.AI_SPEED_MULTIPLIER = 1.0;
                    settings.AI_REACTION_TIME = 5;
                    break;
            }
        }

        function loadSavedSettings() {
            document.getElementById('match-duration').value = savedSettings.matchDuration;
            document.getElementById('difficulty').value = savedSettings.difficulty;
            
            settings.MATCH_DURATION = savedSettings.matchDuration;
            settings.DIFFICULTY = savedSettings.difficulty;
            
            switch(savedSettings.difficulty) {
                case 'easy':
                    settings.AI_SPEED_MULTIPLIER = 0.6;
                    settings.AI_REACTION_TIME = 20;
                    break;
                case 'normal':
                    settings.AI_SPEED_MULTIPLIER = 0.8;
                    settings.AI_REACTION_TIME = 10;
                    break;
                case 'hard':
                    settings.AI_SPEED_MULTIPLIER = 1.0;
                    settings.AI_REACTION_TIME = 5;
                    break;
            }
            
            if (savedSettings.player1ImageData) {
                const img = new Image();
                img.onload = () => {
                    player1Image = img;
                    document.getElementById('p1-preview').innerHTML = '<img src="' + savedSettings.player1ImageData + '" alt="Oyuncu 1">';
                };
                img.src = savedSettings.player1ImageData;
            }
            
            if (savedSettings.player2ImageData) {
                const img = new Image();
                img.onload = () => {
                    player2Image = img;
                    document.getElementById('p2-preview').innerHTML = '<img src="' + savedSettings.player2ImageData + '" alt="Oyuncu 2">';
                };
                img.src = savedSettings.player2ImageData;
            }
            
            if (savedSettings.backgroundImageData) {
                const img = new Image();
                img.onload = () => {
                    backgroundImage = img;
                    document.getElementById('bg-preview').innerHTML = '<img src="' + savedSettings.backgroundImageData + '" alt="Arkaplan">';
                };
                img.src = savedSettings.backgroundImageData;
            }
            
            if (savedSettings.ballImageData) {
                const img = new Image();
                img.onload = () => {
                    ballImage = img;
                    document.getElementById('ball-preview').innerHTML = '<img src="' + savedSettings.ballImageData + '" alt="Top">';
                };
                img.src = savedSettings.ballImageData;
            }
            
            if (savedSettings.goal1ImageData) {
                const img = new Image();
                img.onload = () => {
                    goal1Image = img;
                    document.getElementById('goal1-preview').innerHTML = '<img src="' + savedSettings.goal1ImageData + '" alt="Sol Kale">';
                };
                img.src = savedSettings.goal1ImageData;
            }
            
            if (savedSettings.goal2ImageData) {
                const img = new Image();
                img.onload = () => {
                    goal2Image = img;
                    document.getElementById('goal2-preview').innerHTML = '<img src="' + savedSettings.goal2ImageData + '" alt="Sağ Kale">';
                };
                img.src = savedSettings.goal2ImageData;
            }
        }

        // Oyun akışı fonksiyonları
        function startGame() {
            gameState = 'PLAYING';
            startScreen.style.display = 'none';
            endScreen.style.display = 'none';
            settingsScreen.style.display = 'none';
            gameControls.style.display = 'block';
            
            updateControlVisibility();
            
            player1.score = 0;
            player2.score = 0;
            timer = settings.MATCH_DURATION;
            goalScored = false; // Reset gol bayrağı
            resetPositions();

            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if(gameState === 'PLAYING') {
                    timer--;
                    if (timer <= 0) {
                        endGame();
                    }
                }
            }, 1000);
        }

        function endGame() {
            clearInterval(timerInterval);
            gameState = 'GAME_OVER';

            if (player1.score > player2.score) {
                resultText.textContent = gameMode === 'single' ? 'KAZANDIN!' : 'OYUNCU 1 KAZANDI!';
                resultText.style.color = '#00FF00';
            } else if (player2.score > player1.score) {
                resultText.textContent = gameMode === 'single' ? 'KAYBETTİN!' : 'OYUNCU 2 KAZANDI!';
                resultText.style.color = '#FF4136';
            } else {
                resultText.textContent = 'BERABERE!';
                resultText.style.color = '#FFD700';
            }
            
            finalScoreText.textContent = `Skor: ${player1.score} - ${player2.score}`;
            endScreen.style.display = 'flex';
            gameControls.style.display = 'none';
        }

        // Ana oyun döngüsü
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            drawField();
            
            if (gameState === 'PLAYING') {
                handlePlayerInput(player1);
                if (!player2.isAI) {
                    handlePlayerInput(player2);
                } else {
                    updateAI(player2);
                }

                updatePhysics(player1);
                updatePhysics(player2);
                updateBall();

                checkCollision(player1, ball);
                checkCollision(player2, ball);
                checkGoal();
            }

            drawPlayer(player1, player1Image);
            drawPlayer(player2, player2Image);
            drawBall();
            drawUI();
            
            // Gol mesajını en üstte çiz
            drawGoalMessage();
            
            requestAnimationFrame(gameLoop);
        }

        // Event listener'lar
        function setupEventListeners() {
            document.getElementById('single-mode-btn').addEventListener('click', () => {
                gameMode = 'single';
                player2.isAI = true;
                startGame();
            });

            document.getElementById('two-player-mode-btn').addEventListener('click', () => {
                gameMode = 'two-player';
                player2.isAI = false;
                startGame();
            });

            document.getElementById('settings-btn').addEventListener('click', () => {
                showSettings();
            });

            document.getElementById('restart-btn').addEventListener('click', () => {
                startGame();
            });

            document.getElementById('main-menu-btn').addEventListener('click', () => {
                showMainMenu();
            });

            document.getElementById('save-settings-btn').addEventListener('click', () => {
                saveSettings();
                showMainMenu();
            });

            document.getElementById('back-to-menu-btn').addEventListener('click', () => {
                showMainMenu();
            });

            // Dosya yükleme
            document.getElementById('p1-char-input').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            player1Image = img;
                            savedSettings.player1ImageData = event.target.result;
                            document.getElementById('p1-preview').innerHTML = '<img src="' + event.target.result + '" alt="Oyuncu 1">';
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            document.getElementById('p2-char-input').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            player2Image = img;
                            savedSettings.player2ImageData = event.target.result;
                            document.getElementById('p2-preview').innerHTML = '<img src="' + event.target.result + '" alt="Oyuncu 2">';
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            document.getElementById('bg-input').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            backgroundImage = img;
                            savedSettings.backgroundImageData = event.target.result;
                            document.getElementById('bg-preview').innerHTML = '<img src="' + event.target.result + '" alt="Arkaplan">';
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            document.getElementById('ball-input').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            ballImage = img;
                            savedSettings.ballImageData = event.target.result;
                            document.getElementById('ball-preview').innerHTML = '<img src="' + event.target.result + '" alt="Top">';
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            document.getElementById('goal1-input').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            goal1Image = img;
                            savedSettings.goal1ImageData = event.target.result;
                            document.getElementById('goal1-preview').innerHTML = '<img src="' + event.target.result + '" alt="Sol Kale">';
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            document.getElementById('goal2-input').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            goal2Image = img;
                            savedSettings.goal2ImageData = event.target.result;
                            document.getElementById('goal2-preview').innerHTML = '<img src="' + event.target.result + '" alt="Sağ Kale">';
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            // Temizleme butonları
            document.getElementById('clear-p1').addEventListener('click', () => {
                player1Image = null;
                savedSettings.player1ImageData = null;
                if (defaultImages.player1) {
                    const img = new Image();
                    img.onload = () => {
                        player1Image = img;
                        document.getElementById('p1-preview').innerHTML = '<img src="' + defaultImages.player1 + '" alt="Sol Oyuncu">';
                    };
                    img.onerror = () => {
                        document.getElementById('p1-preview').innerHTML = 'Varsayılan';
                    };
                    img.src = defaultImages.player1;
                } else {
                    document.getElementById('p1-preview').innerHTML = 'Varsayılan';
                }
            });

            document.getElementById('clear-p2').addEventListener('click', () => {
                player2Image = null;
                savedSettings.player2ImageData = null;
                if (defaultImages.player2) {
                    const img = new Image();
                    img.onload = () => {
                        player2Image = img;
                        document.getElementById('p2-preview').innerHTML = '<img src="' + defaultImages.player2 + '" alt="Sağ Oyuncu">';
                    };
                    img.onerror = () => {
                        document.getElementById('p2-preview').innerHTML = 'Varsayılan';
                    };
                    img.src = defaultImages.player2;
                } else {
                    document.getElementById('p2-preview').innerHTML = 'Varsayılan';
                }
            });

            document.getElementById('clear-bg').addEventListener('click', () => {
                backgroundImage = null;
                savedSettings.backgroundImageData = null;
                if (defaultImages.background) {
                    const img = new Image();
                    img.onload = () => {
                        backgroundImage = img;
                        document.getElementById('bg-preview').innerHTML = '<img src="' + defaultImages.background + '" alt="Arkaplan">';
                    };
                    img.onerror = () => {
                        document.getElementById('bg-preview').innerHTML = 'Varsayılan';
                    };
                    img.src = defaultImages.background;
                } else {
                    document.getElementById('bg-preview').innerHTML = 'Varsayılan';
                }
            });

            document.getElementById('clear-ball').addEventListener('click', () => {
                ballImage = null;
                savedSettings.ballImageData = null;
                if (defaultImages.ball) {
                    const img = new Image();
                    img.onload = () => {
                        ballImage = img;
                        document.getElementById('ball-preview').innerHTML = '<img src="' + defaultImages.ball + '" alt="Top">';
                    };
                    img.onerror = () => {
                        document.getElementById('ball-preview').innerHTML = 'Varsayılan';
                    };
                    img.src = defaultImages.ball;
                } else {
                    document.getElementById('ball-preview').innerHTML = 'Varsayılan';
                }
            });

            document.getElementById('clear-goal1').addEventListener('click', () => {
                goal1Image = null;
                savedSettings.goal1ImageData = null;
                if (defaultImages.goal1) {
                    const img = new Image();
                    img.onload = () => {
                        goal1Image = img;
                        document.getElementById('goal1-preview').innerHTML = '<img src="' + defaultImages.goal1 + '" alt="Sol Kale">';
                    };
                    img.onerror = () => {
                        document.getElementById('goal1-preview').innerHTML = 'Varsayılan';
                    };
                    img.src = defaultImages.goal1;
                } else {
                    document.getElementById('goal1-preview').innerHTML = 'Varsayılan';
                }
            });

            document.getElementById('clear-goal2').addEventListener('click', () => {
                goal2Image = null;
                savedSettings.goal2ImageData = null;
                if (defaultImages.goal2) {
                    const img = new Image();
                    img.onload = () => {
                        goal2Image = img;
                        document.getElementById('goal2-preview').innerHTML = '<img src="' + defaultImages.goal2 + '" alt="Sağ Kale">';
                    };
                    img.onerror = () => {
                        document.getElementById('goal2-preview').innerHTML = 'Varsayılan';
                    };
                    img.src = defaultImages.goal2;
                } else {
                    document.getElementById('goal2-preview').innerHTML = 'Varsayılan';
                }
            });
        }

        // Başlatma fonksiyonu
        function init() {
            setupGameControls();
            setupEventListeners();
            loadDefaultImages();
            loadSavedSettings();
            showMainMenu();
            gameLoop();
        }

        // Sayfa yüklendiğinde başlat
        if (document.readyState === 'loading') {
            window.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>